define("websock",["util","crypto","jquery"],function(e){var t=10,n=1,r=2,i=3,s=function(e,t){try{e.send(t)}catch(n){console.log(n)}},o=function(t){return CryptoJS.MD5(e.getSecret()+e.getNick()+e.lpad(t,"0",16))},u=function(t,n,r){var i=Server.getTime(),s=JSON.stringify({to:n,from:[e.getNick()],message:r}),u=["1",t.toString(),e.aesEncrypto(s,i,o(i)),i.toString()];return JSON.stringify(u)},a=function(n,r){var i=Server.getTime(),s=JSON.stringify({method:n,args:r}),u=["1",t.toString(),e.aesEncrypto(s,i,o(i)),i.toString()];return JSON.stringify(u)},f={conn:null,open:function(i,s){try{var u=this;this.conn=new WebSocket(i),this.conn.onopen=function(e){s(e),u.afterOpen(e)},this.conn.onclose=function(e){u.onClose(e)},this.conn.onerror=function(e){u.onError(e)},this.conn.onmessage=function(i){var s=JSON.parse(i.data),u=parseInt(s[1]),a=s[3],f="";s[0]=="1"?f=e.aesDecrypto(s[2],a,o(a)):f=s[2];if(f==""){alert("返回数据为空！");return}switch(u){case t:var l=JSON.parse(f);$(document).trigger("socket."+l.method,l.args);break;case n:case r:var c=JSON.parse(f);console.log(c.message)}}}catch(a){alert(a)}},afterOpen:function(e){console.log("initDo")},sendMessage:function(e,t){s(this.conn,u(n,[e],t))},sendMessageToUsers:function(e,t){s(this.conn,u(r,e,t))},sendMessageToGroup:function(e,t){s(this.conn,u(i,[e],t))},callErrorCount:0,sendCall:function(e,t){console.log("sendCall",e,this.conn.readyState);if(this.conn.readyState==0){if(this.callErrorCount>100)return;var n=this;window.setTimeout(function(){n.callErrorCount++,s(n.conn,a(e,t))},200)}else this.conn.readyState==1&&(this.callErrorCount=0,s(this.conn,a(e,t)))},close:function(){this.conn.close()},onClose:function(e){console.log("onClose"),console.log(e)},onError:function(e){console.log("onError"),console.log(e)}};return f.prepare=function(e,t){if(f.conn&&f.conn.readyState==1)return;f.open(e,t)},f});